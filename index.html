<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Builder 3D</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://unpkg.com">
</head>
<body>
    <header id="toolbar">
        <div class="toolbar-left">
            <h1>Process Builder 3D</h1>
        </div>
        <div class="toolbar-actions">
            <button id="btn-save" title="Spara process">&#128190; Spara</button>
            <button id="btn-load" title="Ladda process">&#128194; Ladda</button>
            <button id="btn-move" title="Flytta vald komponent (M)">&#8693; Flytta</button>
            <button id="btn-rotate" title="Rotera vald komponent (R)">&#8635; Rotera</button>
            <button id="btn-delete" title="Ta bort vald komponent (Delete)">&#128465; Ta bort</button>
            <button id="btn-clear" title="Rensa allt">&#128260; Rensa</button>
            <button id="btn-undo" title="√Öngra (Ctrl+Z)" disabled>&#8617; √Öngra</button>
            <button id="btn-redo" title="G√∂r om (Ctrl+Y)" disabled>&#8618; G√∂r om</button>
            <button id="btn-simulate" title="Starta/Stoppa simulering">&#9654; Simulera</button>
            <button id="btn-sequences" title="Uppstartssekvenser">&#128218; Sekvenser</button>
            <button id="btn-faults" title="Fels√∂kningsscenarier">&#128295; Fels√∂kning</button>
            <button id="btn-export-pid" title="Exportera P&ID-diagram (SVG)">&#128203; P&amp;ID</button>
            <button id="btn-exam-mode" title="Prov-L√§ge: d√∂ljer hj√§lpfunktioner f√∂r examination">&#127891; Prov-L√§ge</button>
            <button id="btn-emergency" class="emergency-btn" title="N√∂dstopp (Space)">&#9888; N√ñDSTOPP</button>
        </div>
    </header>

    <main id="app">
        <aside id="library-panel">
            <!-- Built dynamically by componentLibrary.js -->
        </aside>

        <div id="viewport">
            <canvas id="three-canvas"></canvas>
            <div id="exam-mode-banner" style="display:none;">üéì PROV-L√ÑGE AKTIVT ‚Äî Automatisk media, kompatibilitetsfeedback och auto-koppling √§r inaktiverade</div>
            <div id="status-bar">Klicka p√• en komponent i biblioteket och sedan i 3D-vyn f√∂r att placera</div>
            <!-- Port-info tooltip -->
            <div id="port-tooltip" style="display:none;">
                <div class="port-tooltip-comp"></div>
                <div class="port-tooltip-portname"></div>
                <div class="port-tooltip-porttype"></div>
                <div class="port-tooltip-hint"></div>
            </div>
            <!-- Instrument panel (processv√§rden, visas under furnace-scenario) -->
            <div id="instrument-panel" style="display:none;">
                <div class="inst-header">üìä Processv√§rden</div>
                <div id="inst-pv-list"></div>
            </div>

            <!-- Sekvens-panel (steg under k√∂rning) -->
            <div id="sequence-panel" style="display:none;">
                <div class="seq-panel-header">
                    <span id="seq-panel-title">Sekvens</span>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button id="btn-debug-mode" class="seq-debug-toggle" title="Debugl√§ge (hoppa steg)">üîß</button>
                        <button id="btn-cancel-sequence" class="seq-cancel-btn">&times;</button>
                    </div>
                </div>
                <!-- Debug controls ‚Äî visas n√§r debugl√§ge √§r aktivt -->
                <div id="seq-debug-bar" style="display:none;">
                    <span class="seq-debug-label">Hoppa till steg:</span>
                    <input type="number" id="seq-debug-step" min="1" value="1" class="seq-debug-input">
                    <button id="btn-debug-jump" class="seq-debug-btn">Hoppa</button>
                    <button id="btn-debug-next" class="seq-debug-btn seq-debug-next">N√§sta ‚Üí</button>
                </div>
                <div id="seq-progress-bar"><div id="seq-progress-fill"></div></div>
                <div id="seq-step-info">
                    <div id="seq-step-label" class="seq-step-label">Steg 1/5</div>
                    <div id="seq-step-instruction" class="seq-step-instruction"></div>
                    <div id="seq-step-detail" class="seq-step-detail"></div>
                </div>
                <div id="seq-step-status" class="seq-step-status"></div>
                <!-- CCR-interaktionsknapp (visas enbart f√∂r furnace_ccr-steg) -->
                <div id="seq-ccr-action" style="display:none;">
                    <div class="seq-ccr-message" id="seq-ccr-message"></div>
                    <button id="btn-ccr-confirm" class="seq-ccr-btn"></button>
                </div>
                <!-- Timer-display (visas enbart f√∂r furnace_timer-steg) -->
                <div id="seq-timer-display" class="seq-timer-display" style="display:none;"></div>
                <!-- PV-wait display (visas enbart f√∂r furnace_wait_pv-steg) -->
                <div id="seq-pv-wait-display" class="seq-pv-wait-display" style="display:none;"></div>
            </div>
        </div>

        <aside id="properties-panel">
            <h2>Egenskaper</h2>
            <div id="properties-content">
                <p class="placeholder-text">V√§lj en komponent f√∂r att se egenskaper</p>
            </div>
        </aside>
        <!-- N√∂dstopp overlay -->
        <div id="emergency-overlay" class="modal-overlay" style="display:none;">
            <div class="emergency-content">
                <div class="emergency-icon">&#9888;</div>
                <h2>N√ñDSTOPP AKTIVERAT</h2>
                <p>All simulering har stoppats. Alla komponenter √§r avst√§ngda.</p>
                <button id="btn-emergency-reset" class="emergency-reset-btn">√Öterst√§ll</button>
            </div>
        </div>

        <!-- Sekvens-modal (v√§lj sekvens) -->
        <div id="sequence-modal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Guider &amp; √ñvningar</h2>
                    <button id="btn-close-seq-modal" class="modal-close-btn">&times;</button>
                </div>
                <p class="modal-desc">V√§lj en bygg√∂vning f√∂r att tr√§na p√• att konstruera en process, eller en uppstartssekvens f√∂r att √∂va p√• att k√∂ra ig√•ng en befintlig anl√§ggning.</p>
                <div id="sequence-card-list"></div>
            </div>
        </div>

        <!-- Media-val modal -->
        <div id="media-modal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>V√§lj media</h2>
                    <button id="btn-close-media-modal" class="modal-close-btn">&times;</button>
                </div>
                <p class="modal-desc">V√§lj vilken media/produkt som fl√∂dar genom r√∂rledningen.</p>
                <input type="text" id="media-search" class="lib-search" placeholder="S√∂k media..." style="margin-bottom:12px;" />
                <div id="media-card-list"></div>
            </div>
        </div>

        <!-- Fels√∂knings-modal -->
        <div id="fault-modal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Fels√∂kningsscenarier</h2>
                    <button id="btn-close-fault-modal" class="modal-close-btn">&times;</button>
                </div>
                <p class="modal-desc">V√§lj ett scenario f√∂r att √∂va p√• att diagnostisera och √•tg√§rda processfel.</p>
                <div id="fault-card-list"></div>
            </div>
        </div>

        <!-- Spara-modal -->
        <div id="save-modal" class="modal-overlay" style="display:none;">
            <div class="modal-content save-load-modal">
                <div class="modal-header">
                    <h2>&#128190; Spara process</h2>
                    <button id="btn-close-save-modal" class="modal-close-btn">&times;</button>
                </div>
                <p class="modal-desc">Ange ett namn och spara processen. Du kan ha flera namngivna processer parallellt.</p>
                <div class="save-name-row">
                    <input type="text" id="save-name-input" class="lib-search save-name-input" placeholder="Processnamn..." maxlength="60" />
                    <button id="btn-save-confirm" class="modal-action-btn">Spara</button>
                </div>
                <div id="save-name-warning" class="save-name-warning" style="display:none;"></div>
                <div class="save-section-label">Sparade processer</div>
                <div id="save-existing-list" class="save-existing-list">
                    <p class="save-empty-msg">Inga sparade processer √§n.</p>
                </div>
                <div class="modal-divider"></div>
                <div class="modal-footer-actions">
                    <button id="btn-export-json" class="modal-secondary-btn" title="Ladda ner nuvarande arbetsyta som JSON-fil">&#8595; Exportera som JSON-fil</button>
                </div>
            </div>
        </div>

        <!-- Ladda-modal -->
        <div id="load-modal" class="modal-overlay" style="display:none;">
            <div class="modal-content save-load-modal">
                <div class="modal-header">
                    <h2>&#128194; Ladda process</h2>
                    <button id="btn-close-load-modal" class="modal-close-btn">&times;</button>
                </div>
                <p class="modal-desc">V√§lj en sparad process att ladda, eller importera en JSON-fil fr√•n disk.</p>
                <div id="load-saves-list" class="save-existing-list">
                    <p class="save-empty-msg">Inga sparade processer √§n. Spara en process eller importera en JSON-fil.</p>
                </div>
                <div class="modal-divider"></div>
                <div class="modal-footer-actions">
                    <button id="btn-import-json" class="modal-secondary-btn" title="Importera en process fr√•n JSON-fil">&#8593; Importera JSON-fil</button>
                    <input type="file" id="import-json-input" accept=".json" style="display:none;" />
                </div>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script src="js/media.js"></script>
    <script src="js/components.js"></script>
    <script src="js/componentLibrary.js"></script>
    <script src="js/sequences.js"></script>
    <script src="js/pid-export.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
